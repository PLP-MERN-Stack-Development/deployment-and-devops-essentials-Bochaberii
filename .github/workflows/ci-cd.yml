name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Backend Tests and Linting
  backend-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Week5-Chat/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: Week5-Chat/backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check for syntax errors
        run: node --check src/server.js

  # Frontend Tests and Linting
  frontend-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Week5-Chat/frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: Week5-Chat/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Build application
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SOCKET_URL: ${{ secrets.VITE_SOCKET_URL }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}

      - name: Run tests
        run: npm test || echo "No tests configured yet"

  # Deploy Backend to Render/Railway/Heroku
  deploy-backend:
    needs: backend-ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Render
        run: |
          echo "Backend deployment triggered automatically on Render"
          # Render auto-deploys when connected to GitHub
          # Add webhook trigger here if needed

  # Deploy Frontend to Vercel/Netlify
  deploy-frontend:
    needs: frontend-ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Vercel
        run: |
          echo "Frontend deployment triggered automatically on Vercel"
          # Vercel auto-deploys when connected to GitHub
          # Add webhook trigger here if needed
